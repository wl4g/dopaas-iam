# Copyright (c) 2017 ~ 2025, the original author wangl.sir individual Inc,
# All rights reserved. Contact us <jameswong1376@gmail.com, 983708408@qq.com>
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

## TODO: Short-circuit AND operation is not supported?
{{- if .Values.global.mongodb.enabled }}
{{- if eq .Values.global.mongodb.provider "external" }}
## see:https://kubernetes.io/zh/docs/concepts/services-networking/service/#headless-services
apiVersion: v1
kind: Service
metadata:
  name: mongodb-{{ .Chart.Name }}-headless
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/release: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
spec:
  type: ClusterIP
  sessionAffinity: None
  clusterIP: None
  publishNotReadyAddresses: true
---
apiVersion: v1
kind: Endpoints
metadata:
  name: mongodb-{{ .Chart.Name }}-headless
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/release: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
subsets:
- addresses:
  {{- range $index, $ip := regexSplit "," .Values.global.mongodb.external.ips -1 }}
  - ip: {{ $ip }}
  {{- end}}
  ports:
  {{- range $index, $port := regexSplit "," .Values.global.mongodb.external.ports -1 }}
  - name: external-mongodb-{{$index}}
    port: {{ $port }}
    protocol: TCP
  {{- end}}
{{- end}}
{{- end}}