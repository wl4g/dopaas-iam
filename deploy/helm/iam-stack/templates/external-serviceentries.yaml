# Copyright (c) 2017 ~ 2025, the original author wangl.sir individual Inc,
# All rights reserved. Contact us James Wrong <983708408@qq.com>
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

{{- $releaseNamespace := .Release.Namespace }}

{{- range $name, $app := .Values.global.components }}
{{- if $app.external.enabled }}
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: {{ $name }}-serviceentry
  namespace: {{ $app.external.namespace | default $releaseNamespace }}
spec:
  hosts:
  - {{ $name }}-headless.{{ $app.external.namespace | default $releaseNamespace }}.svc.cluster.local
  {{- if not (empty $app.external.customHosts) }}
  {{- toYaml $app.external.customHosts | nindent 2 }}
  {{- end }}
  location: {{ $app.external.location | default "MESH_EXTERNAL" }}
  ports:
  {{- if empty $app.external.instancePorts }}
  - name: http-{{ $name }}
    protocol: HTTP
    number: 80
    targetPort: 80
  - name: https-{{ $name }}
    protocol: HTTPS
    number: 443
    targetPort: 443
  {{- else }}
  {{- range $index, $port := $app.external.instancePorts }}
  - name: {{ $port.protocol | lower }}-{{ $name }}-{{ $index }}
    protocol: {{ $port.protocol | upper }}
    number: {{ $port.targetPort }}
    targetPort: {{ $port.targetPort }}
  {{- end }}
  {{- end }}
  resolution: STATIC
  workloadSelector:
    labels:
      app: {{ $name }}
---
{{- range $index, $addr := $app.external.instanceAddresses }}
apiVersion: networking.istio.io/v1beta1
kind: WorkloadEntry
metadata:
  name: {{ $name }}-workloadentry-{{ $index }}
  namespace: {{ $app.external.namespace | default $releaseNamespace }}
spec:
  {{- if not (empty $app.external.serviceAccount) }}
  serviceAccount: {{ $app.external.serviceAccount }}
  {{- end}}
  address: {{ $addr }}
  labels:
    app: {{ $name }}
    classify: {{ $app.external.labels.classify }}
    version: {{ $app.external.labels.version }}
---
{{- end }}

{{- end }}
{{- end }}