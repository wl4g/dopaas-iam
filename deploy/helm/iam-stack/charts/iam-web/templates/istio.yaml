# Copyright (c) 2017 ~ 2025, the original author wangl.sir individual Inc,
# All rights reserved. Contact us <Wanglsir@gmail.com, 983708408@qq.com>
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

{{- if eq .Values.governance.type "Istio" }}
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ template "app.name" . }}-api
  labels:
    app.kubernetes.io/name: {{ template "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ template "app.chart" . }}
spec:
  gateways:
    - {{ template "app.name" . }}-gw
  hosts:
  {{- if not (empty .Values.governance.istio.domains) }}
  - {{- toYaml .Values.governance.istio.domains | nindent 4 }}
  {{- else }}
  - {{- .Values.governance.istio.domains | default "api.example.io" }}
  {{- end }}
  http:
    {{- range $match := .Values.governance.istio.routeMatchConfigs }}
    - {{- $match }}
    {{- end }}

---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ template "app.name" . }}-gw
  labels:
    app.kubernetes.io/name: {{ template "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ template "app.chart" . }}
spec:
  selector:
    istio: ingressgateway
  servers:
    - hosts:
      {{- if not (empty .Values.governance.istio.domains) }}
      - {{- toYaml .Values.governance.istio.domains | nindent 4 }}
      {{- else }}
      - {{- .Values.governance.istio.domains | default "app.example.io" }}
      {{- end }}
      port:
        {{- if eq .Values.governance.istio.mode "http" }}
        name: http-{{ template "app.name" . }}
        number: 80
        protocol: HTTP
        {{- else if eq .Values.governance.istio.mode "https" }}
        name: https-{{ template "app.name" . }}
        number: 443
        protocol: HTTPS
        tls:
          mode: {{- .Values.governance.istio.https.tlsMode | default "SIMPLE" }}
          # for example:
          # openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=wl4g Inc./CN=*.wl4g.io' -keyout wl4g.io.key -out wl4g.io.crt
          # kubectl create -n istio-system secret tls wl4g-credential --key=wl4g.io.key --cert=wl4g.io.crt
          # kubectl apply -f istio-specs.yaml -n securesvc
          credentialName: wl4g-credential
        {{- end }}

{{- end }}
